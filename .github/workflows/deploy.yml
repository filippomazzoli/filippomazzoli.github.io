name: deploy

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Updating `papers.bib` file from my academic-CV repository
        uses: wow-actions/download-upload@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN_CV }}
          url: https://github.com/filippomazzoli/academic-CV/blob/master/TeX-files/papers.bib
          dir: _bibliography
      - name: Updating `cv.pdf` file from my academic-CV repository
        uses: wow-actions/download-upload@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN_CV }}
          url: https://github.com/filippomazzoli/academic-CV/blob/master/TeX-files/main.pdf
          dir: assets/pdf
      - name: Commit and Push the up-to-date files  `paper.bib` and `main.pdf`
        run: |
         git config --global user.name "github-actions[bot]"
         git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
         git add -A
         git diff-index --quiet HEAD || git commit -m 'Updated papers.bib and main.pdf from academic-CV'
         git push
  deploy:
    needs: update
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.2'
          bundler-cache: true
      - name: Install and Build üîß
        run: |
          pip3 install --upgrade jupyter
          npm install -g mermaid.cli
          export JEKYLL_ENV=production
          bundle exec jekyll build
      - name: Deploy üöÄ
        if: github.event_name != 'pull_request'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: _site
